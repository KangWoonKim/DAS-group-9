---
title: "Obesity in Scotland in relation to factors included in the Scottish Health Surveys of 2008 and 2012"
author: "Group 9 (2718740K Kyle Kim)"
number-sections: true 
format: 
  html:
    embed-resources: true
    code-tools: true
  pdf: default
editor_options: 
  chunk_output_type: console
---

# Introduction {#sec-intro}

Obesity represents a significant public health issue globally, linked to numerous chronic diseases and a major cause of premature morbidity and mortality. This project examines the prevalence and determinants of obesity in Scotland, using data from the Scottish Health Surveys between 2008 and 2012. It aims to identify trends in obesity rates over the years and explore how demographic factors, socio-economic status, and lifestyle choices such as diet impact obesity levels. Through descriptive statistics and logistic regression analysis, the study seeks to provide insights into the patterns of obesity across different population segments, offering evidence-based recommendations for public health strategies to mitigate this growing health concern.

Obesity is a serious health concern to those it involves. Scotland has the highest obesity rate in the UK in addition to having one of the highest in the developed world which clearly emphasises the significance of the problem. In terms of the effects high obesity rates can have on Scotland, there are many including increased mortality rates, increased healthcare costs and less people in work which negatively impacts the economy. The Scottish health surveys from 2008 and 2012 collected data from individuals regarding their Age, Sex, Education, Body Mass Index (BMI) and whether they consumed the recommended daily fruit and vegetable intake. In this report, we will be investigating whether the prevalence of obesity in Scotland between 2008 and 2012 has changed. Additionally, whether the obesity status of individuals is effected differently in relation to their age, gender, socio-economic status or lifestyle factors.

Background, How the data are collected The aim of this project

In @sec-eda, we will study the relationship between obesity and various influencing factors, including age, gender, education level, and daily consumption of vegetables and fruits. This section aims to uncover preliminary insights and trends within the data through exploratory data analysis techniques.

Moreover, @sec-fda consists of the results from fitting the regression model to the data and evaluating the assumptions of the model. This segment will delve into logistic regression analyses to quantify the impact of different predictors on obesity, providing a more nuanced understanding of its determinants.

The conclusion will be given in @sec-ccls, where we synthesize our findings, discuss the implications for public health policy and practice, and suggest directions for future research. This final section aims to encapsulate the key insights derived from the analysis and underscore their relevance to tackling obesity in Scotland.

```{r}
#| warning: false
#| message: false 
#| echo: false 
library(ggplot2)
library(dplyr)
library(moderndive)
library(skimr)
library(kableExtra)
library(gridExtra)
library(gapminder)
library(MASS)
library(knitr)
library(datasets)
library(broom)
library(infer)
library(janitor)
library(tidyr)
library(ISLR)
library(readr)
library(stats)
library(sjPlot)
library(patchwork)
library(tidymodels)
```

# Exploratory data analysis {#sec-eda}

```{r}
#| warning: false
#| message: false 
#| echo: false 

data <- read_csv("DAProject1.csv")
data <- na.omit(data)

data$Obese <- as.factor(data$Obese)
data$Sex <- as.factor(data$Sex)
data$Education <- as.factor(data$Education)
data$Veg <- as.factor(data$Veg)
data$Fruit <- as.factor(data$Fruit)


```

```{r}
#| warning: false
#| message: false 
#| echo: false 
obesity_prevalence <- data %>%
  group_by(Year) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_prevalence_long <- pivot_longer(obesity_prevalence, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")

obesity_Age <- data %>%
  group_by(Age) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_age_long <- pivot_longer(obesity_Age, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")


obesity_Sex <- data %>%
  group_by(Sex) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_Sex_long <- pivot_longer(obesity_Sex, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")


obesity_Edu <- data %>%
  group_by(Education) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_Edu_long <- pivot_longer(obesity_Edu, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")


obesity_Veg <- data %>%
  group_by(Veg) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_Veg_long <- pivot_longer(obesity_Veg, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")

obesity_Fruit <- data %>%
  group_by(Fruit) %>%
  summarise(Obese_Yes = sum(Obese == "Yes") / n() * 100,
            Obese_No = sum(Obese == "No") / n() * 100)
obesity_Fruit_long <- pivot_longer(obesity_Fruit, c("Obese_Yes", "Obese_No"), names_to = "Obesity", values_to = "Percentage")
```

```{r}
#| echo: false
#| fig-cap: Scotland's Obesity prevalence over the factors
#| label: fig-bar
#| fig-align: center
#| message: false
#| warning: false

# Plot 


# Plot
p1<-ggplot(obesity_age_long, aes(x = Age, y = Percentage, fill = Obesity)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Obesity prevalence in Scotland by Age",
       x = "Age",
       y = "Percentage (%)",
       fill = "Obesity Status")

# Plot 
p2<-ggplot(obesity_Sex_long, aes(x = Sex, y = Percentage, fill = Obesity)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Obesity prevalence in Scotland by Sex",
       x = "Sex",
       y = "Percentage (%)",
       fill = "Obesity Status")

# Plot 
p3<- ggplot(obesity_Edu_long, aes(x = Education, y = Percentage, fill = Obesity)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Obesity prevalence in Scotland by Education",
       x = "Education",
       y = "Percentage (%)",
       fill = "Obesity Status")+
  theme(axis.text.x = element_text(size = 2))

# Plot 
p4<-ggplot(obesity_Veg_long, aes(x = Veg, y = Percentage, fill = Obesity)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Obesity prevalence in Scotland by Veg",
       x = "Veg",
       y = "Percentage (%)",
       fill = "Obesity Status")

# Plot 
p5<-ggplot(obesity_Fruit_long, aes(x = Fruit, y = Percentage, fill = Obesity)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Obesity prevalence in Scotland by Fruit",
       x = "Fruit",
       y = "Percentage (%)",
       fill = "Obesity Status")


```

@tbl-obe_year indicates that the lowest percentage of subjects with obesity recorded was in 2009, with the peak being in 2010 (at 30.5%) and the rate decreasing after this year.

```{r}
#| echo: false
#| label: tbl-obe_year
#| tbl-cap: prevalence of obesity over the year 2008 - 2012
obesity_by_year <- data %>%
  group_by(Year) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_year)
```

This is also clear in @fig-line_year:

```{r}
#| warning: false
#| message: false 
#| echo: false 
#| fig-cap: Percentage of obese people in Scotland by year
#| label: fig-line_year
ggplot(data=obesity_prevalence, mapping=aes(x=Year, y=Obese_Yes))+
 geom_line()+
     labs(title = "Obesity prevalence in Scotland by Year",
          x = "Year",
          y = "Percentage of Obesity (%)",
          )
```

In @tbl-obe_Age and @fig-bar_age, there seems to be a trend of increasing obesity percentage as age increases, peaking at the 60-70 range (at 35.9%) then falling down, with 90+ having the lowest percentage.

```{r}
#| echo: false
#| label: tbl-obe_Age
#| tbl-cap: Obesity percentage table by age group
data$Age_Group <- cut(data$Age, breaks=c(0, 18, 30, 40, 50, 60, 70,80,90,Inf), labels=c("0-18", "19-30", "31-40", "41-50", "51-60", "60-70","70-80","80-90","90+"))
obesity_by_age_group <- data %>%
  group_by(Age_Group) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_age_group)
```

```{r}
#| echo: false
#| fig-cap: Percentage of obese people in Scotland by age group
#| label: fig-bar_age
#| fig-align: center
#| message: false
#| warning: false

p1
```

It seems as though the female and male percentages are roughly the same, with the obesity percentage of females only just being higher than that of males by 0.4%, as shown in @tbl-obe_sex and @fig- bar_sex .

```{r}
#| echo: false
#| label: tbl-obe_sex
#| tbl-cap: Obesity percentage table by gender
obesity_by_sex <- data %>%
  group_by(Sex) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_sex)
```

```{r}
#| echo: false
#| fig-cap: Percentage of obese people in Scotland by Gender
#| label: fig-bar_sex
#| fig-align: center
#| message: false
#| warning: false

p2
```

We can see from @tbl-obe_edu that those with no qualification have the highest percentage of obesity (at 36.5%) and the lowest rate being those with a degree or higher (at 24.8%), this is supported in @fig-bar_edu.

```{r}
#| echo: false
#| label: tbl-obe_edu
#| tbl-cap:  Obesity percentage table by education
obesity_by_education <- data %>%
  group_by(Education) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_education)
```

```{r}
#| echo: false
#| fig-cap: Percentage of obese people in Scotland by Education
#| label: fig-bar_edu
#| fig-align: center
#| message: false
#| warning: false

p3
```

@tbl-ob_veg and @fig-bar_Veg show that those who did consume the recommended vegetable intake had a lower obesity percentage than those who didn't by 3.2%.

```{r}
#| echo: false
#| label: tbl-ob_veg
#| tbl-cap:  Obesity percentage table by vegetarian
obesity_by_veg <- data %>%
  group_by(Veg) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_veg)
```

```{r}
#| echo: false
#| fig-cap: Percentage of obese people in Scotland by Vegetarian
#| label: fig-bar_Veg
#| fig-align: center
#| message: false
#| warning: false


p4
```

There was not a big difference between those who consumed the recommended daily intake of fruit and those who did not, with those who did having a 0.3% higher obesity percentage, as shown in @tbl-ob_fruit and @fig-bar_Fruit.

```{r}
#| echo: false
#| label: tbl-ob_fruit
#| tbl-cap:  Obesity percentage table by fruit
obesity_by_fruit <- data %>%
  group_by(Fruit) %>%
  summarise(Obesity_Percentage = mean(Obese == "Yes") * 100)
kable(obesity_by_fruit)
```

```{r}
#| echo: false
#| fig-cap: Percentage of obese people in Scotland by Fruit
#| label: fig-bar_Fruit
#| fig-align: center
#| message: false
#| warning: false

p5
```

# Formal data analysis {#sec-fda}

Next, we formally analyse the data by considering objective in turn. Firstly, we fitting the logistic regression model since we get binary outcome of obese_yes or obese_no. Equation containing the explanatory variable and response variable as follows:

$$
\ \log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 Age(x_1) + \beta_2 Sex(x_2) + \beta_3 Education(x_3)+\beta_4Veg(x_4) + \beta_5 Fruit(x_5) + \epsilon, ~~\epsilon \sim N(0, \sigma^2)
$$

where

-   $p$ denotes the probability of the outcome being obese (outcome 1)

-   $\beta_0$ denotes the intercept

-   $\beta_1 , \cdot\cdot\cdot,\beta_5$ denotes the coefficients of the predictor variables

-   $\epsilon$ denotes random error component which are normally distributed with mean zero

-   $\sigma^2$ denotes variance

we can fit the logistic regression model as follows @tbl-regmodel1:

```{r}
#| echo: false
#| label: tbl-regmodel1
#| tbl-cap: Estimates of the regression model coefficients.

obesity_by_factors <- data |>
  dplyr::select(Obese, Age, Sex, Education, Veg, Fruit)

model_factors <- logistic_reg() |>
  set_engine("glm") |>
  fit(Obese ~ Age + Sex + Education + Veg + Fruit, data =obesity_by_factors) |>
  extract_fit_engine()

dataframeone <- data.frame(
  Groups = c( "Intercept", "Age","Sex (Male)","Education Higher","Education HNC/D", "Education no", "Education other", "Education Standard", "Vegetable intake", "Fruit intake"),
  Estimates = summary(model_factors)$coefficients[,1],
  pvalues = summary(model_factors)$coefficients[,4]
)

kable(dataframeone, row.names = FALSE)

```

from the `model_factors` we observe that `Sex (Male)` and `Fruit intake` are not significant parameters since the p-values are greater than 0.05 . So, we use stepAIC function to find a better model.

Thus, we can make new regression model without those two factors.

```{r}
#| echo: false
#| output: false


AIC <- stepAIC(model_factors)

```

```{r}
#| echo: false
#| label: tbl-regmodel2
#| tbl-cap: Estimates of the regression model coefficients.
dataframe <- data.frame(
  Groups = c( "Intercept", "Age","Education Higher","Education HNC/D", "Education no", "Education other", "Education Standard", "Vegetable intake"),
  Estimates = summary(AIC)$coefficients[,1],
  pvalues = summary(AIC)$coefficients[,4]
)

kable(dataframe, row.names = FALSE)
```

Hence, the regression line is given by :

$$
\ \log\left(\frac{p}{1-p}\right) = -1.556 + 0.012 Age+ 0.148Education_{Higher}+0.240Education_{HNC/D}\\+0.386Education_{No}+0.219Education_{Other}+0.305Education_{Standard}-0.140Veg + \epsilon, ~~\epsilon \sim N(0, \sigma^2)
$$

where p is probability of being obese and 1-p is probability of being not obese. Hence the log-odds of the being Obese increase by 0.012 for every unit increase in `age`. This provides us with a point estimate of how the log-odds changes with age.

However, we are also interested in producing a 95% confidence interval for these log-odds. These intervals are shown in @tbl-the_log_odds:

```{r}
#| echo: false
#| label: tbl-the_log_odds
#| tbl-cap: Confidence interval of the Log Odds 

mod.factors.coef.logodds <- AIC |>
  summary()|>
  coef()

Age.logodds.lower <- (mod.factors.coef.logodds["Age", "Estimate"]- 1.96 * mod.factors.coef.logodds["Age", "Std. Error"])

Age.logodds.upper <- (mod.factors.coef.logodds["Age", "Estimate"] + 1.96 * mod.factors.coef.logodds["Age", "Std. Error"])


Edu.higher.logodds.lower <- (mod.factors.coef.logodds["EducationHigher grade or equiv", "Estimate"]- 1.96 * mod.factors.coef.logodds["EducationHigher grade or equiv", "Std. Error"])

Edu.higher.logodds.upper <- (mod.factors.coef.logodds["EducationHigher grade or equiv", "Estimate"] + 1.96 * mod.factors.coef.logodds["EducationHigher grade or equiv", "Std. Error"])


Edu.HNC.logodds.lower <- (mod.factors.coef.logodds["EducationHNC/D or equiv", "Estimate"]- 1.96 * mod.factors.coef.logodds["EducationHNC/D or equiv", "Std. Error"])

Edu.HNC.logodds.upper <- (mod.factors.coef.logodds["EducationHNC/D or equiv", "Estimate"] + 1.96 * mod.factors.coef.logodds["EducationHNC/D or equiv", "Std. Error"])


Edu.no.logodds.lower <- (mod.factors.coef.logodds["EducationNo qualifications", "Estimate"]- 1.96 * mod.factors.coef.logodds["EducationNo qualifications", "Std. Error"])

Edu.no.logodds.upper <- (mod.factors.coef.logodds["EducationNo qualifications", "Estimate"] + 1.96 * mod.factors.coef.logodds["EducationNo qualifications", "Std. Error"])

Edu.other.logodds.lower <- (mod.factors.coef.logodds["EducationOther school level", "Estimate"]- 1.96 * mod.factors.coef.logodds["EducationOther school level", "Std. Error"])

Edu.other.logodds.upper <- (mod.factors.coef.logodds["EducationOther school level", "Estimate"] + 1.96 * mod.factors.coef.logodds["EducationOther school level", "Std. Error"])


Edu.standard.logodds.lower <- (mod.factors.coef.logodds["EducationStandard grade or equiv", "Estimate"]- 1.96 * mod.factors.coef.logodds["EducationStandard grade or equiv", "Std. Error"])

Edu.standard.logodds.upper <- (mod.factors.coef.logodds["EducationStandard grade or equiv", "Estimate"] + 1.96 * mod.factors.coef.logodds["EducationStandard grade or equiv", "Std. Error"])


Veg.logodds.lower <- (mod.factors.coef.logodds["VegYes", "Estimate"]- 1.96 * mod.factors.coef.logodds["VegYes", "Std. Error"])

Veg.logodds.upper <- (mod.factors.coef.logodds["VegYes", "Estimate"] + 1.96 * mod.factors.coef.logodds["VegYes", "Std. Error"])



# Store the results in a data frame
log_odds_ci <- data.frame(
  groups = c( "Age","Education Higher","Education HNC/D", "Education no", "Education other", "Education Standard", "Vegetable intake"),
  lodds = summary(AIC)$coefficients[2:8,1],
  ci_low = c(Age.logodds.lower,Edu.higher.logodds.lower,Edu.HNC.logodds.lower,Edu.no.logodds.lower,Edu.other.logodds.lower, Edu.standard.logodds.lower,Veg.logodds.lower),
  ci_up = c(Age.logodds.upper, Edu.higher.logodds.upper, Edu.HNC.logodds.upper, Edu.no.logodds.upper,Edu.other.logodds.upper, Edu.standard.logodds.upper, Veg.logodds.upper)
)

kable(log_odds_ci, col.names = c("Groups", "Log-odds", "confidence interval low boundary", "confidence interval upper boundary"), caption = "Confidence interval of the log odds", format="pipe", row.names = FALSE)
```

We can see these log-odds intervals visually in @fig-log_odds:

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-log_odds
#| fig-cap: Log odds of each parameter
#| fig-align: center


#plot_model(model_factors, show.values = TRUE, transform = NULL,title = "Log-Odds", show.p=FALSE, axis.lim = c(-0.2, 0.4))
plot_model(AIC, show.values = TRUE, transform = NULL,title = "Log-Odds", show.p=FALSE, axis.lim = c(-0.2, 0.4))
```

From this output and figure we can see that `Age` and all `Education` variables have greater odds of association with the obesity response variable, however whether the person consumes the recommended amount of vegetables has lower odds of association with obesity rates.

```{r}
#| echo: false
#| label: tbl-the_odds
#| tbl-cap: Confidence interval of the Odds 

# Store the results in a data frame
odds_ci <- data.frame(
  groups = c( "Age","Education Higher","Education HNC/D", "Education no", "Education other", "Education Standard", "Vegetable intake"),
  ci_low = c(exp(Age.logodds.lower),exp(Edu.higher.logodds.lower),exp(Edu.HNC.logodds.lower),exp(Edu.no.logodds.lower),exp(Edu.other.logodds.lower), exp(Edu.standard.logodds.lower),exp(Veg.logodds.lower)),
  ci_up = c(exp(Age.logodds.upper), exp(Edu.higher.logodds.upper), exp(Edu.HNC.logodds.upper), exp(Edu.no.logodds.upper),exp(Edu.other.logodds.upper), exp(Edu.standard.logodds.upper), exp(Veg.logodds.upper))
)

kable(odds_ci, col.names = c("Groups", "confidence interval low boundary", "confidence interval uppter boundary"), caption = "Confidence interval of the odds", format="pipe")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-odds
#| fig-cap: odds of each parameter
#| fig-align: center
plot_model(AIC, show.values = TRUE,title = "Odds", show.p = FALSE,axis.lim = c(0.5, 2))
#plot_model(model_factors, show.values = TRUE,title = "Odds", show.p = FALSE,axis.lim = c(0.5, 2))
```

@fig-odds shows odds of each values

```{r}
#| echo: false
#| label: tbl-pred_age
#| tbl-cap: Predicted probabilities of obesity by Age

pred <- predict(model_factors, type= "response")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-pred_Age
#| fig-cap: Predicted probabilities of obesity by Age 
#| fig-align: center

plot_model(model_factors, type = "pred", terms= "Age[all]")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-pred_Edu
#| fig-cap: Predicted probabilities of obesity by Education
#| fig-align: center

plot_model(model_factors, type = "pred", terms= "Education")
```

we dont consider sex or

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-pred_Sex
#| fig-cap: Predicted probabilities of obesity by Sex
#| fig-align: center

plot_model(model_factors, type = "pred", terms = "Sex")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-pred_Veg
#| fig-cap: Predicted probabilities of obesity by Veg
#| fig-align: center

plot_model(model_factors, type = "pred", terms = "Veg")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-pred_Fruit
#| fig-cap: Predicted probabilities of obesity by Fruit
#| fig-align: center


plot_model(model_factors, type = "pred", terms = "Fruit")
```

# Conclusions {#sec-ccls}

Findings of q1 and q2

Future study
